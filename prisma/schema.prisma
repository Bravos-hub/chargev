generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  // System Administration
  SUPER_ADMIN
  PLATFORM_ADMIN

  // Organization Management
  ORG_OWNER
  ORG_ADMIN

  // Station Ownership & Management
  STATION_OWNER_INDIVIDUAL
  STATION_OWNER_ORG
  STATION_ADMIN
  STATION_ATTENDANT

  // Technical Support
  TECHNICIAN_PUBLIC
  TECHNICIAN_ORG

  // Fleet Management
  FLEET_MANAGER
  FLEET_DRIVER

  // End Users
  RIDER_PREMIUM
  RIDER_STANDARD
  GUEST

  // Legacy (for backwards compatibility)
  EVZONE_ADMIN
  EVZONE_OPERATOR
  EVZONE_OWNER
  EVZONE_SITE_OWNER
  EVZONE_TECH
  EVZONE_DRIVER
  EVZONE_FLEET_MANAGER
}

enum OrgType {
  CHARGING_NETWORK
  FLEET_OPERATOR
  PROPERTY_MANAGEMENT
  MUNICIPALITY
}

enum StationStatus {
  ONLINE
  DEGRADED
  OFFLINE
  MAINTENANCE
}

enum StationType {
  CHARGE
  SWAP
  BOTH
}

enum SessionStatus {
  PENDING
  ACTIVE
  PAUSED
  COMPLETED
  FAILED
  CANCELLED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CHECKED_IN
  IN_PROGRESS
  COMPLETED
  CANCELLED
  EXPIRED
  // Legacy
  RESERVED
}

enum PaymentMethod {
  CARD
  MOBILE_MONEY
  WALLET
  CASH
  BANK_TRANSFER
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  CANCELLED
  REFUNDED
}

enum CommandStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
}

enum InvoiceStatus {
  PAID
  PENDING
  OVERDUE
  REFUNDED
}

enum NotificationStatus {
  UNREAD
  READ
}

enum NotificationChannel {
  IN_APP
  EMAIL
  SMS
  PUSH
}

enum NotificationType {
  SESSION_STARTED
  SESSION_COMPLETED
  BOOKING_CONFIRMED
  BOOKING_REMINDER
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  MAINTENANCE_DUE
  FAULT_DETECTED
  WALLET_LOW_BALANCE
  SYSTEM_ALERT
}

enum PackStatus {
  AVAILABLE
  CHARGING
  ASSIGNED
  IN_USE
  MAINTENANCE
  RESERVED
  FAULTY
}

enum SwapStatus {
  INITIATED
  PACK_REMOVED
  PACK_INSTALLED
  COMPLETED
  CANCELLED
}

enum AccessType {
  OWNER
  PERMANENT
  TEMPORARY
  GUEST_PASS
  ONE_TIME
}

enum ScheduleType {
  AVAILABILITY
  PRICING
  RESTRICTED
  MAINTENANCE
}

enum PricingType {
  FLAT_RATE
  TIME_BASED
  ENERGY_BASED
  TIME_OF_USE
  DYNAMIC
}

// New Enums for Enhanced Architecture

enum WebhookStatus {
  ACTIVE
  PAUSED
  DISABLED
  FAILED
}

enum OCPIRole {
  CPO
  EMSP
  HUB
  NSP
}

enum OCPIStatus {
  PENDING
  ACTIVE
  SUSPENDED
  DISCONNECTED
}

enum ConnectorType {
  TYPE_1
  TYPE_2
  CCS1
  CCS2
  CHADEMO
  GBT_AC
  GBT_DC
  NACS
  TESLA
}

enum PowerType {
  AC_1_PHASE
  AC_3_PHASE
  DC
}

enum ConnectorStatus {
  AVAILABLE
  PREPARING
  CHARGING
  SUSPENDED_EVSE
  SUSPENDED_EV
  FINISHING
  RESERVED
  UNAVAILABLE
  FAULTED
}

enum DriverStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  ON_LEAVE
}

enum ShiftStatus {
  SCHEDULED
  ACTIVE
  COMPLETED
  MISSED
  CANCELLED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum IncidentSeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum IncidentStatus {
  OPEN
  ACKNOWLEDGED
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum JobType {
  MAINTENANCE
  REPAIR
  INSTALLATION
  INSPECTION
  EMERGENCY
}

enum JobPriority {
  P0
  P1
  P2
  P3
}

enum JobStatus {
  OPEN
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  SLA_BREACH
}

// Pricing & Subscription Enums
enum PricingRuleType {
  TIME_OF_USE
  DEMAND_RESPONSE
  FLEET_DISCOUNT
  SUBSCRIPTION_DISCOUNT
  PROMOTIONAL
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAST_DUE
  PAUSED
}

enum SettlementType {
  CPO_PAYOUT
  ROAMING_INCOMING
  ROAMING_OUTGOING
  DRIVER_PAYOUT
  FLEET_BILLING
}

enum SettlementStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  DISPUTED
}

// ============================================================================
// MULTI-TENANCY & ORGANIZATIONS
// ============================================================================

model Tenant {
  id        String         @id @default(cuid())
  name      String
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  orgs      Organization[]
  users     User[]
}

model Organization {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  type      OrgType  @default(CHARGING_NETWORK)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant   Tenant    @relation(fields: [tenantId], references: [id])
  users    User[]    @relation("OrgUsers")
  vehicles Vehicle[]
  stations Station[]
  fleets   Fleet[]
  invoices Invoice[]

  // New relations for enhanced architecture
  apiKeys           APIKey[]
  webhooks          Webhook[]
  ocpiPartners      OCPIPartner[]
  subscriptionPlans SubscriptionPlan[]
  settlements       Settlement[]

  @@index([tenantId])
}

model Fleet {
  id        String   @id @default(cuid())
  name      String
  orgId     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  org      Organization @relation(fields: [orgId], references: [id])
  vehicles Vehicle[]
  drivers  User[]       @relation("FleetDrivers")

  // New relations for fleet partner features
  driverProfiles Driver[]
  shuttleRoutes  ShuttleRoute[]
  tours          Tour[]
  rentalVehicles RentalVehicle[]
  students       Student[]

  @@index([orgId])
}

//============================================================================
// USERS & AUTHENTICATION
// ============================================================================

model User {
  id               String   @id @default(cuid())
  email            String?  @unique
  phone            String?  @unique
  passwordHash     String?
  name             String
  role             UserRole
  tenantId         String
  orgId            String?
  fleetId          String?
  verified         Boolean  @default(false)
  twoFactorEnabled Boolean  @default(false)

  // Frontend Integration
  preferences   Json?   @default("{}") // { language, units, notifications }
  licenseNumber String?
  avatarUrl     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  organization Organization? @relation("OrgUsers", fields: [orgId], references: [id])
  fleet        Fleet?        @relation("FleetDrivers", fields: [fleetId], references: [id])

  refreshTokens   RefreshToken[]
  vehicles        Vehicle[]
  sessions        ChargingSession[]
  swapSessions    SwapSession[]
  bookings        Booking[]         @relation("UserBookings")
  payments        Payment[]
  notifications   Notification[]
  chargerAccess   ChargerAccess[]
  packInspections PackInspection[]
  supportTickets  SupportTicket[]
  supportMessages SupportMessage[]

  walletId String? @unique
  wallet   Wallet?

  // New relations for enhanced architecture
  ratings       Rating[]
  savedRoutes   SavedRoute[]
  driverProfile Driver?
  subscriptions Subscription[]

  @@index([tenantId])
  @@index([orgId])
  @@index([fleetId])
  @@index([email])
  @@index([phone])
}

model RefreshToken {
  id        String    @id @default(cuid())
  userId    String
  token     String    @unique
  tokenHash String
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
}

model OtpCode {
  id         String   @id @default(cuid())
  identifier String // phone or email
  code       String
  type       String // 'phone' | 'email'
  expiresAt  DateTime
  attempts   Int      @default(0)
  verified   Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@index([identifier, type])
}

// ============================================================================
// VEHICLES & DIAGNOSTICS
// ============================================================================

model Vehicle {
  id              String @id @default(cuid())
  vin             String @unique
  make            String
  model           String
  year            Int
  batteryCapacity Float // kWh

  userId  String? // Individual ownership
  orgId   String? // Org ownership
  fleetId String? // Fleet vehicles

  // Frontend Integration
  plate    String?
  color    String?
  odometer Float?  @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user  User?         @relation(fields: [userId], references: [id])
  org   Organization? @relation(fields: [orgId], references: [id])
  fleet Fleet?        @relation(fields: [fleetId], references: [id])

  diagnostics  VehicleDiagnostic[]
  trips        Trip[]
  sessions     ChargingSession[]
  swapSessions SwapSession[]
  maintenance  MaintenanceRecord[]
  faults       FaultCode[]

  // New relations for fleet features
  driverShifts  DriverShift[]
  rentalVehicle RentalVehicle?

  @@index([userId])
  @@index([orgId])
  @@index([fleetId])
  @@index([vin])
}

model VehicleDiagnostic {
  id        String @id @default(cuid())
  vehicleId String

  soc         Float // State of charge %
  range       Float // Estimated range km
  batteryTemp Float // Battery temperature Â°C
  odometer    Float // Odometer km
  efficiency  Float // Wh/km

  timestamp DateTime @default(now())
  vehicle   Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@index([timestamp])
}

model Trip {
  id        String @id @default(cuid())
  vehicleId String

  startLocation String
  endLocation   String
  distance      Float // km
  duration      Int // minutes
  energyUsed    Float // kWh
  efficiency    Float // Wh/km

  startedAt DateTime
  endedAt   DateTime
  createdAt DateTime @default(now())

  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@index([startedAt])
}

model MaintenanceRecord {
  id        String @id @default(cuid())
  vehicleId String

  type        String // 'scheduled' | 'repair' | 'inspection'
  description String
  cost        Decimal @db.Decimal(10, 2)
  status      String // 'pending' | 'completed' | 'cancelled'

  scheduledAt DateTime
  completedAt DateTime?
  createdAt   DateTime  @default(now())

  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@index([status])
}

model FaultCode {
  id        String @id @default(cuid())
  vehicleId String

  code        String
  description String
  severity    String // 'low' | 'medium' | 'high' | 'critical'
  resolved    Boolean @default(false)

  detectedAt DateTime  @default(now())
  resolvedAt DateTime?

  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@index([resolved])
}

// ============================================================================
// STATIONS & CHARGING
// ============================================================================

model Station {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  region    String
  country   String
  address   String
  lat       Float?
  lng       Float?
  images    String[] // URLs to images
  amenities String[] // ["wifi", "cafe", "restroom"]

  orgId  String
  type   StationType
  status StationStatus

  healthScore   Int       @default(100)
  utilization   Int       @default(0)
  connectors    Int       @default(0)
  swapBays      Int       @default(0)
  openIncidents Int       @default(0)
  lastHeartbeat DateTime?

  make  String?
  model String?
  maxKw Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization          @relation(fields: [orgId], references: [id])
  chargePoints ChargePoint[]
  swapStations SwapStation[]
  bookings     Booking[]
  sessions     ChargingSession[]
  commands     CommandJob[]
  policies     SmartChargingPolicy[]
  access       ChargerAccess[]
  schedules    Schedule[]
  pricing      Pricing?

  // New relations for operations management
  incidents Incident[]
  jobs      Job[]

  @@index([orgId])
  @@index([status])
  @@index([type])
}

model ChargePoint {
  id              String        @id @default(cuid())
  stationId       String
  vendor          String?
  model           String?
  serialNumber    String?
  firmwareVersion String?
  status          StationStatus @default(ONLINE)
  maxKw           Int?
  connectorCount  Int           @default(1)
  lastHeartbeat   DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  station    Station           @relation(fields: [stationId], references: [id], onDelete: Cascade)
  sessions   ChargingSession[]
  connectors Connector[]

  @@index([stationId])
}

model SwapStation {
  id         String        @id @default(cuid())
  stationId  String
  providerId String?
  status     StationStatus @default(ONLINE)
  bays       Int           @default(0)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  station  Station       @relation(fields: [stationId], references: [id], onDelete: Cascade)
  provider SwapProvider? @relation(fields: [providerId], references: [id])
  packs    BatteryPack[]
  shelves  Shelf[]
  sessions SwapSession[]

  @@index([stationId])
  @@index([providerId])
}

model SmartChargingPolicy {
  id        String   @id @default(cuid())
  stationId String
  name      String
  active    Boolean  @default(true)
  config    Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  station Station @relation(fields: [stationId], references: [id], onDelete: Cascade)

  @@index([stationId])
}

// ============================================================================
// BOOKINGS & RESERVATIONS
// ============================================================================

model Booking {
  id          String  @id @default(cuid())
  userId      String
  stationId   String
  connectorId String?

  startTime     DateTime
  endTime       DateTime
  status        BookingStatus
  queuePosition Int?

  paymentStatus String  @default("pending") // 'pending' | 'paid' | 'refunded'
  amount        Decimal @db.Decimal(10, 2)

  // Frontend Integration
  mode         String @default("fixed") // 'fixed' | 'mobile'
  energyTarget Float?
  location     Json? // Snapshot of location { lat, lng, address }  

  checkedInAt DateTime?
  cancelledAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations (Note: User relation removed to avoid conflict, use userId directly)
  station Station          @relation(fields: [stationId], references: [id])
  session ChargingSession?
  payment Payment?

  // Legacy compatibility
  startAt DateTime?
  endAt   DateTime?
  user    User      @relation("UserBookings", fields: [userId], references: [id])

  @@index([userId])
  @@index([stationId])
  @@index([status])
}

// ============================================================================
// CHARGING SESSIONS
// ============================================================================

model ChargingSession {
  id            String  @id @default(cuid())
  stationId     String
  chargePointId String?
  userId        String?
  vehicleId     String?
  bookingId     String? @unique

  status    SessionStatus @default(PENDING)
  startedAt DateTime
  endedAt   DateTime?
  kwh       Float?        @default(0)
  amount    Decimal?      @default(0)
  currency  String        @default("USD")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  station     Station      @relation(fields: [stationId], references: [id])
  chargePoint ChargePoint? @relation(fields: [chargePointId], references: [id])
  user        User?        @relation(fields: [userId], references: [id])
  vehicle     Vehicle?     @relation(fields: [vehicleId], references: [id])
  booking     Booking?     @relation(fields: [bookingId], references: [id])

  meterValues MeterValue[]
  payments    Payment[]

  @@index([stationId])
  @@index([userId])
  @@index([vehicleId])
  @@index([status])
}

model MeterValue {
  id         String   @id @default(cuid())
  sessionId  String
  recordedAt DateTime @default(now())
  kwh        Float
  powerKw    Float?
  voltage    Float?
  current    Float?

  session ChargingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([recordedAt])
}

// ============================================================================
// PAYMENTS & WALLET
// ============================================================================

model Payment {
  id        String  @id @default(cuid())
  userId    String
  sessionId String?
  bookingId String? @unique

  amount   Decimal       @db.Decimal(10, 2)
  currency String        @default("USD")
  method   PaymentMethod
  status   PaymentStatus

  // Provider details
  provider     String // 'stripe' | 'mpesa' | 'wallet' | 'cash'
  providerTxId String?
  providerData Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User             @relation(fields: [userId], references: [id])
  session ChargingSession? @relation(fields: [sessionId], references: [id])
  booking Booking?         @relation(fields: [bookingId], references: [id])

  @@index([userId])
  @@index([sessionId])
  @@index([status])
}

model Wallet {
  id        String   @id @default(cuid())
  userId    String   @unique
  balance   Decimal  @default(0) @db.Decimal(10, 2)
  currency  String   @default("USD")
  locked    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions WalletTransaction[]

  @@index([userId])
}

model WalletTransaction {
  id            String   @id @default(cuid())
  walletId      String
  type          String // 'credit' | 'debit'
  amount        Decimal  @db.Decimal(10, 2)
  description   String
  reference     String?
  balanceBefore Decimal  @db.Decimal(10, 2)
  balanceAfter  Decimal  @db.Decimal(10, 2)
  createdAt     DateTime @default(now())

  wallet Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([createdAt])
}

// ============================================================================
// BATTERY SWAP INFRASTRUCTURE
// ============================================================================

model SwapProvider {
  id        String   @id @default(cuid())
  name      String
  logo      String?
  rating    Float?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stations SwapStation[]
  plans    SwapPlan[]
}

model SwapPlan {
  id            String   @id @default(cuid())
  providerId    String
  name          String
  price         Decimal  @db.Decimal(10, 2)
  swapsPerMonth Int
  description   String?
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  provider SwapProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId])
}

model BatteryPack {
  id           String     @id @default(cuid())
  serialNumber String     @unique
  model        String
  capacity     Float // kWh
  soc          Float // State of charge %
  soh          Float // State of health %
  stationId    String
  shelfId      String?
  status       PackStatus
  temperature  Float?
  voltage      Float?
  cycles       Int        @default(0)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  station           SwapStation      @relation(fields: [stationId], references: [id])
  shelf             Shelf?           @relation(fields: [shelfId], references: [id])
  sessionsRemoved   SwapSession[]    @relation("PackRemoved")
  sessionsInstalled SwapSession[]    @relation("PackInstalled")
  inspections       PackInspection[]

  @@index([stationId])
  @@index([shelfId])
  @@index([status])
}

model Shelf {
  id        String   @id @default(cuid())
  stationId String
  position  String // 'A1', 'B2', etc.
  capacity  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  station SwapStation   @relation(fields: [stationId], references: [id], onDelete: Cascade)
  packs   BatteryPack[]

  @@index([stationId])
}

model SwapSession {
  id              String     @id @default(cuid())
  userId          String
  stationId       String
  vehicleId       String?
  packRemovedId   String?
  packInstalledId String
  status          SwapStatus
  paymentId       String?
  signature       String? // Base64 signature
  startedAt       DateTime
  completedAt     DateTime?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  user          User         @relation(fields: [userId], references: [id])
  station       SwapStation  @relation(fields: [stationId], references: [id])
  vehicle       Vehicle?     @relation(fields: [vehicleId], references: [id])
  packRemoved   BatteryPack? @relation("PackRemoved", fields: [packRemovedId], references: [id])
  packInstalled BatteryPack  @relation("PackInstalled", fields: [packInstalledId], references: [id])

  @@index([userId])
  @@index([stationId])
  @@index([vehicleId])
  @@index([status])
}

model PackInspection {
  id          String   @id @default(cuid())
  packId      String
  inspectorId String
  condition   String // 'good' | 'fair' | 'poor'
  notes       String?
  photos      String[] // URLs to photos
  issues      Json? // Structured issue data
  createdAt   DateTime @default(now())

  pack      BatteryPack @relation(fields: [packId], references: [id], onDelete: Cascade)
  inspector User        @relation(fields: [inspectorId], references: [id])

  @@index([packId])
  @@index([inspectorId])
}

// ============================================================================
// PRIVATE CHARGER FEATURES
// ============================================================================

model ChargerAccess {
  id         String     @id @default(cuid())
  stationId  String
  userId     String?
  type       AccessType
  code       String? // For guest passes
  validFrom  DateTime
  validUntil DateTime?
  usageCount Int        @default(0)
  maxUsage   Int?
  active     Boolean    @default(true)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  station Station @relation(fields: [stationId], references: [id], onDelete: Cascade)
  user    User?   @relation(fields: [userId], references: [id])

  @@index([stationId])
  @@index([userId])
  @@index([code])
}

model Schedule {
  id            String       @id @default(cuid())
  stationId     String
  name          String
  type          ScheduleType
  daysOfWeek    Int[] // 0-6 (Sunday-Saturday)
  startTime     String // HH:mm
  endTime       String // HH:mm
  validFrom     DateTime
  validUntil    DateTime?
  priceOverride Decimal?     @db.Decimal(10, 2)
  active        Boolean      @default(true)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  station Station @relation(fields: [stationId], references: [id], onDelete: Cascade)

  @@index([stationId])
  @@index([type])
}

model Pricing {
  id         String      @id @default(cuid())
  stationId  String      @unique
  type       PricingType
  flatRate   Decimal?    @db.Decimal(10, 2)
  perMinute  Decimal?    @db.Decimal(10, 2)
  perHour    Decimal?    @db.Decimal(10, 2)
  perKwh     Decimal?    @db.Decimal(10, 2)
  touEnabled Boolean     @default(false)
  touRates   Json?
  currency   String      @default("USD")
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  station Station       @relation(fields: [stationId], references: [id], onDelete: Cascade)
  rules   PricingRule[]

  @@index([stationId])
}

// ============================================================================
// NOTIFICATIONS & SUPPORT
// ============================================================================

model Notification {
  id        String              @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  body      String
  data      Json?
  channel   NotificationChannel @default(IN_APP)
  status    NotificationStatus  @default(UNREAD)
  read      Boolean             @default(false)
  readAt    DateTime?
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([type])
}

model SupportTicket {
  id          String           @id @default(cuid())
  userId      String
  subject     String
  description String
  status      String           @default("OPEN") // 'OPEN', 'IN_PROGRESS', 'CLOSED'
  priority    String           @default("LOW") // 'LOW', 'MEDIUM', 'HIGH'
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  messages    SupportMessage[]

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model SupportMessage {
  id        String   @id @default(cuid())
  ticketId  String
  userId    String
  content   String
  isAdmin   Boolean  @default(false)
  createdAt DateTime @default(now())

  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([userId])
}

model FAQ {
  id        String   @id @default(cuid())
  question  String
  answer    String
  category  String?
  order     Int      @default(0)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================================================
// LEGACY/UTILITY MODELS
// ============================================================================

model CommandJob {
  id        String        @id @default(cuid())
  stationId String
  command   String
  status    CommandStatus @default(QUEUED)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  station Station @relation(fields: [stationId], references: [id], onDelete: Cascade)

  @@index([stationId])
  @@index([status])
}

model Invoice {
  id        String        @id @default(cuid())
  orgId     String
  amount    Decimal       @db.Decimal(10, 2)
  currency  String        @default("USD")
  status    InvoiceStatus
  issuedAt  DateTime
  dueAt     DateTime
  paidAt    DateTime?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  organization Organization @relation(fields: [orgId], references: [id])

  @@index([orgId])
  @@index([status])
}

model PaymentIntent {
  id        String   @id @default(cuid())
  userId    String?
  amount    Decimal  @db.Decimal(10, 2)
  currency  String   @default("USD")
  status    String
  provider  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Transaction {
  id        String   @id @default(cuid())
  userId    String?
  amount    Decimal  @db.Decimal(10, 2)
  currency  String   @default("USD")
  type      String
  status    String
  reference String?
  createdAt DateTime @default(now())

  @@index([userId])
}

// ============================================================================
// METADATA & AUDIT INFRASTRUCTURE
// ============================================================================

model AuditLog {
  id         String   @id @default(cuid())
  tenantId   String
  userId     String?
  entityType String // 'Station', 'User', 'Booking', etc.
  entityId   String
  action     String // 'CREATE', 'UPDATE', 'DELETE', 'LOGIN', etc.
  changes    Json? // { field: { old, new } }
  ipAddress  String?
  userAgent  String?
  metadata   Json? // Additional context
  createdAt  DateTime @default(now())

  @@index([tenantId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

model Metadata {
  id         String   @id @default(cuid())
  entityType String // 'Station', 'User', 'Vehicle', etc.
  entityId   String
  key        String
  value      Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([entityType, entityId, key])
  @@index([entityType, entityId])
}

model MediaAsset {
  id         String   @id @default(cuid())
  tenantId   String
  entityType String?
  entityId   String?
  type       String // 'image', 'document', 'signature'
  filename   String
  url        String
  mimeType   String
  size       Int
  metadata   Json? // dimensions, duration, etc.
  uploadedBy String?
  createdAt  DateTime @default(now())

  @@index([entityType, entityId])
  @@index([tenantId])
}

// ============================================================================
// API & INTEGRATION MANAGEMENT
// ============================================================================

model APIKey {
  id             String    @id @default(cuid())
  organizationId String
  name           String
  keyHash        String    @unique
  keyPrefix      String // First 8 chars for identification
  permissions    String[] // ['stations:read', 'sessions:write']
  rateLimit      Int       @default(1000) // requests per hour
  active         Boolean   @default(true)
  expiresAt      DateTime?
  lastUsedAt     DateTime?
  lastUsedIp     String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([keyPrefix])
}

model Webhook {
  id              String        @id @default(cuid())
  organizationId  String
  name            String
  url             String
  events          String[] // ['session.started', 'booking.created']
  secret          String
  headers         Json? // Custom headers
  status          WebhookStatus @default(ACTIVE)
  retryPolicy     Json? // { maxRetries, backoffMs }
  lastTriggeredAt DateTime?
  failureCount    Int           @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  logs         WebhookLog[]

  @@index([organizationId])
  @@index([status])
}

model WebhookLog {
  id         String   @id @default(cuid())
  webhookId  String
  event      String
  payload    Json
  statusCode Int?
  response   String?
  duration   Int? // milliseconds
  success    Boolean
  retries    Int      @default(0)
  error      String?
  createdAt  DateTime @default(now())

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([createdAt])
}

// ============================================================================
// OCPI / ROAMING
// ============================================================================

model OCPIPartner {
  id             String     @id @default(cuid())
  organizationId String
  partyId        String // 2-char party ID
  countryCode    String // 2-char ISO
  name           String
  role           OCPIRole
  version        String // '2.2.1'
  url            String
  tokenA         String // Our token to them
  tokenB         String? // Their token to us
  status         OCPIStatus @default(PENDING)
  lastSyncAt     DateTime?
  syncErrors     Int        @default(0)
  endpoints      Json? // Module endpoints
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  cdrs         OCPICDR[]

  @@unique([partyId, countryCode])
  @@index([organizationId])
}

model OCPICDR {
  id            String   @id @default(cuid())
  partnerId     String
  externalId    String // Partner's CDR ID
  sessionId     String?
  startDateTime DateTime
  endDateTime   DateTime
  energyKwh     Decimal  @db.Decimal(10, 4)
  totalCost     Decimal  @db.Decimal(10, 2)
  currency      String
  status        String // 'SENT', 'ACKNOWLEDGED', 'FAILED'
  rawData       Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  partner OCPIPartner @relation(fields: [partnerId], references: [id])

  @@index([partnerId])
  @@index([sessionId])
}

// ============================================================================
// RATINGS & REVIEWS
// ============================================================================

model Rating {
  id          String    @id @default(cuid())
  userId      String
  entityType  String // 'Station', 'Driver', 'SwapStation'
  entityId    String
  score       Int // 1-5
  review      String?
  tags        String[] // ['fast', 'clean', 'reliable']
  photos      String[]
  response    String? // Owner/admin response
  respondedAt DateTime?
  verified    Boolean   @default(false) // Verified transaction
  sessionId   String? // Link to session for verification
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([userId])
  @@index([score])
}

// ============================================================================
// ENHANCED CHARGING INFRASTRUCTURE - CONNECTOR MODEL
// ============================================================================

model Connector {
  id               String          @id @default(cuid())
  chargePointId    String
  connectorId      Int // OCPP connector ID (1, 2, etc.)
  type             ConnectorType
  powerType        PowerType
  maxPowerKw       Decimal         @db.Decimal(6, 2)
  voltage          Int?
  amperage         Int?
  status           ConnectorStatus @default(AVAILABLE)
  currentSessionId String?
  lastStatusAt     DateTime?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  chargePoint ChargePoint @relation(fields: [chargePointId], references: [id], onDelete: Cascade)

  @@unique([chargePointId, connectorId])
  @@index([status])
}

// ============================================================================
// FLEET PARTNER EXTENSIONS - DRIVER MANAGEMENT
// ============================================================================

model Driver {
  id            String       @id @default(cuid())
  userId        String       @unique
  fleetId       String
  licenseNumber String
  licenseExpiry DateTime
  licenseClass  String?
  status        DriverStatus @default(ACTIVE)
  rating        Decimal?     @db.Decimal(2, 1)
  totalTrips    Int          @default(0)
  totalEarnings Decimal      @default(0) @db.Decimal(10, 2)
  bankAccount   Json? // Encrypted payment info
  documents     Json? // License, insurance uploads
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  user    User           @relation(fields: [userId], references: [id])
  fleet   Fleet          @relation(fields: [fleetId], references: [id])
  shifts  DriverShift[]
  ratings DriverRating[]
  payouts DriverPayout[]

  @@index([fleetId])
  @@index([status])
}

model DriverShift {
  id              String      @id @default(cuid())
  driverId        String
  vehicleId       String?
  startTime       DateTime
  endTime         DateTime?
  status          ShiftStatus @default(SCHEDULED)
  checkInAt       DateTime?
  checkOutAt      DateTime?
  checkInLocation Json?
  notes           String?
  createdAt       DateTime    @default(now())

  driver  Driver   @relation(fields: [driverId], references: [id])
  vehicle Vehicle? @relation(fields: [vehicleId], references: [id])

  @@index([driverId])
  @@index([startTime])
}

model DriverRating {
  id        String   @id @default(cuid())
  driverId  String
  tripId    String?
  userId    String // Rating given by
  score     Int // 1-5
  comment   String?
  createdAt DateTime @default(now())

  driver Driver @relation(fields: [driverId], references: [id])

  @@index([driverId])
}

model DriverPayout {
  id          String       @id @default(cuid())
  driverId    String
  periodStart DateTime
  periodEnd   DateTime
  grossAmount Decimal      @db.Decimal(10, 2)
  deductions  Decimal      @default(0) @db.Decimal(10, 2)
  netAmount   Decimal      @db.Decimal(10, 2)
  currency    String       @default("USD")
  status      PayoutStatus @default(PENDING)
  paidAt      DateTime?
  reference   String?
  breakdown   Json? // Detailed calculation
  createdAt   DateTime     @default(now())

  driver Driver @relation(fields: [driverId], references: [id])

  @@index([driverId])
  @@index([status])
}

// ============================================================================
// SCHOOL SHUTTLE SERVICE
// ============================================================================

model ShuttleRoute {
  id          String   @id @default(cuid())
  fleetId     String
  name        String
  description String?
  status      String   @default("ACTIVE")
  vehicleId   String?
  driverId    String?
  schedule    Json? // { days: [1,2,3,4,5], departureTime: '07:30' }
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  fleet    Fleet         @relation(fields: [fleetId], references: [id])
  stops    RouteStop[]
  students Student[]
  trips    ShuttleTrip[]

  @@index([fleetId])
}

model RouteStop {
  id          String   @id @default(cuid())
  routeId     String
  name        String
  address     String
  lat         Float
  lng         Float
  sequence    Int
  arrivalTime String? // Expected arrival time
  createdAt   DateTime @default(now())

  route ShuttleRoute @relation(fields: [routeId], references: [id], onDelete: Cascade)

  @@index([routeId])
}

model Student {
  id            String   @id @default(cuid())
  fleetId       String
  routeId       String?
  name          String
  school        String
  grade         String?
  parentName    String
  parentPhone   String
  parentEmail   String?
  pickupStopId  String?
  dropoffStopId String?
  photo         String?
  notes         String?
  status        String   @default("ACTIVE")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  fleet Fleet         @relation(fields: [fleetId], references: [id])
  route ShuttleRoute? @relation(fields: [routeId], references: [id])

  @@index([fleetId])
  @@index([routeId])
}

model ShuttleTrip {
  id          String    @id @default(cuid())
  routeId     String
  vehicleId   String
  driverId    String
  date        DateTime
  direction   String // 'PICKUP' or 'DROPOFF'
  status      String    @default("SCHEDULED")
  startedAt   DateTime?
  completedAt DateTime?
  attendance  Json? // { studentId: 'PRESENT' | 'ABSENT' }
  notes       String?
  createdAt   DateTime  @default(now())

  route ShuttleRoute @relation(fields: [routeId], references: [id])

  @@index([routeId])
  @@index([date])
}

// ============================================================================
// TOUR & RENTAL SERVICES
// ============================================================================

model Tour {
  id          String   @id @default(cuid())
  fleetId     String
  name        String
  description String?
  duration    Int // minutes
  capacity    Int
  price       Decimal  @db.Decimal(10, 2)
  currency    String   @default("USD")
  images      String[]
  itinerary   Json? // Array of stops/activities
  inclusions  String[]
  status      String   @default("ACTIVE")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  fleet    Fleet         @relation(fields: [fleetId], references: [id])
  bookings TourBooking[]

  @@index([fleetId])
}

model TourBooking {
  id            String   @id @default(cuid())
  tourId        String
  customerName  String
  customerEmail String
  customerPhone String
  date          DateTime
  participants  Int
  totalAmount   Decimal  @db.Decimal(10, 2)
  status        String   @default("PENDING")
  vehicleId     String?
  driverId      String?
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tour Tour @relation(fields: [tourId], references: [id])

  @@index([tourId])
  @@index([date])
}

model RentalVehicle {
  id          String   @id @default(cuid())
  fleetId     String
  vehicleId   String   @unique
  dailyRate   Decimal  @db.Decimal(10, 2)
  weeklyRate  Decimal? @db.Decimal(10, 2)
  monthlyRate Decimal? @db.Decimal(10, 2)
  currency    String   @default("USD")
  deposit     Decimal  @db.Decimal(10, 2)
  minAge      Int      @default(21)
  available   Boolean  @default(true)
  features    String[]
  terms       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  fleet    Fleet           @relation(fields: [fleetId], references: [id])
  vehicle  Vehicle         @relation(fields: [vehicleId], references: [id])
  bookings RentalBooking[]

  @@index([fleetId])
  @@index([available])
}

model RentalBooking {
  id              String   @id @default(cuid())
  rentalVehicleId String
  customerName    String
  customerEmail   String
  customerPhone   String
  licenseNumber   String
  startDate       DateTime
  endDate         DateTime
  totalAmount     Decimal  @db.Decimal(10, 2)
  depositPaid     Decimal  @default(0) @db.Decimal(10, 2)
  status          String   @default("PENDING")
  pickupLocation  String?
  returnLocation  String?
  mileageStart    Int?
  mileageEnd      Int?
  fuelStart       Int? // percentage
  fuelEnd         Int?
  damages         Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  rentalVehicle RentalVehicle @relation(fields: [rentalVehicleId], references: [id])

  @@index([rentalVehicleId])
  @@index([startDate, endDate])
}

// ============================================================================
// ROUTE PLANNING
// ============================================================================

model SavedRoute {
  id          String    @id @default(cuid())
  userId      String
  name        String
  origin      Json // { lat, lng, address }
  destination Json // { lat, lng, address }
  waypoints   Json? // Array of charging stops
  distance    Float // km
  duration    Int // minutes
  vehicleId   String?
  preferences Json? // { avoidTolls, chargingBuffer, etc. }
  isFavorite  Boolean   @default(false)
  lastUsedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

// ============================================================================
// INCIDENTS & MAINTENANCE JOBS
// ============================================================================

model Incident {
  id             String           @id @default(cuid())
  tenantId       String
  stationId      String?
  assetType      String? // 'ChargePoint', 'BatteryPack', etc.
  assetId        String?
  severity       IncidentSeverity
  title          String
  description    String
  status         IncidentStatus   @default(OPEN)
  reportedBy     String
  assignedTo     String?
  slaDeadline    DateTime?
  acknowledgedAt DateTime?
  resolvedAt     DateTime?
  resolution     String?
  photos         String[]
  metadata       Json?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  station Station? @relation(fields: [stationId], references: [id])
  jobs    Job[]

  @@index([tenantId])
  @@index([stationId])
  @@index([status])
  @@index([severity])
}

model Job {
  id          String      @id @default(cuid())
  tenantId    String
  incidentId  String?
  stationId   String?
  type        JobType
  priority    JobPriority
  title       String
  description String?
  assignedTo  String?
  dueDate     DateTime?
  slaDeadline DateTime?
  status      JobStatus   @default(OPEN)
  startedAt   DateTime?
  completedAt DateTime?
  resolution  String?
  timeSpent   Int? // minutes
  parts       Json? // Parts used
  photos      String[]
  signature   String? // Completion signature
  metadata    Json?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  incident Incident? @relation(fields: [incidentId], references: [id])
  station  Station?  @relation(fields: [stationId], references: [id])

  @@index([tenantId])
  @@index([stationId])
  @@index([assignedTo])
  @@index([status])
}

// ============================================================================
// ADVANCED PRICING & SUBSCRIPTIONS
// ============================================================================

model PricingRule {
  id         String          @id @default(cuid())
  pricingId  String
  name       String
  type       PricingRuleType
  priority   Int             @default(0)
  conditions Json // { startHour, endHour, minDemandKw, fleetId, etc. }
  adjustment Json // { type: 'multiplier'|'fixed'|'discount', value: 1.5 }
  active     Boolean         @default(true)
  validFrom  DateTime?
  validUntil DateTime?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  pricing Pricing @relation(fields: [pricingId], references: [id], onDelete: Cascade)

  @@index([pricingId])
  @@index([type])
  @@index([active])
}

model SubscriptionPlan {
  id          String   @id @default(cuid())
  orgId       String
  name        String
  description String?
  price       Decimal  @db.Decimal(10, 2)
  currency    String   @default("USD")
  interval    String // 'monthly', 'yearly'
  features    Json // { freeKwh: 100, discountPercent: 15, priorityBooking: true }
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organization  Organization   @relation(fields: [orgId], references: [id])
  subscriptions Subscription[]

  @@index([orgId])
  @@index([active])
}

model Subscription {
  id                 String             @id @default(cuid())
  userId             String
  planId             String
  status             SubscriptionStatus @default(ACTIVE)
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelledAt        DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  user User             @relation(fields: [userId], references: [id])
  plan SubscriptionPlan @relation(fields: [planId], references: [id])

  @@index([userId])
  @@index([planId])
  @@index([status])
}

// ============================================================================
// SETTLEMENTS & RECONCILIATION
// ============================================================================

model Settlement {
  id          String           @id @default(cuid())
  orgId       String
  type        SettlementType
  periodStart DateTime
  periodEnd   DateTime
  grossAmount Decimal          @db.Decimal(12, 2)
  fees        Decimal          @db.Decimal(10, 2)
  netAmount   Decimal          @db.Decimal(12, 2)
  currency    String           @default("USD")
  status      SettlementStatus @default(PENDING)
  lineItems   Json // Detailed breakdown
  partnerId   String? // For OCPI roaming
  driverId    String? // For driver payouts
  paidAt      DateTime?
  reference   String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  organization Organization @relation(fields: [orgId], references: [id])

  @@index([orgId])
  @@index([type])
  @@index([status])
  @@index([periodStart, periodEnd])
}
